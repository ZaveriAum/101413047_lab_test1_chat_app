<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Chat</title>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <h1>Group Chat</h1>
    <script>
        const socket = io();
        let typingTimeout;
        const username = localStorage.getItem('username');

        function joinGroup() {
            const groupRadio = document.querySelector('input[name="group"]:checked');
            const groupName = groupRadio ? groupRadio.value : null;
            if (groupName) {
                socket.emit('join_group', groupName);
            }
        }

        socket.on('group_chat_history', (messages) => {
            const container = document.getElementById('container');
            container.innerHTML = '';

            messages.forEach(msg => {
                const messageHTML = `<p><b>${msg.from}:</b> ${msg.message} <i>${new Date(msg.date_sent).toLocaleTimeString()}</i></p>`;
                container.innerHTML += messageHTML;
            });
        });

        function sendGroupMessage() {
            const groupRadio = document.querySelector('input[name="group"]:checked');
            const groupName = groupRadio ? groupRadio.value : null;
            if (!groupName) return;
            
            const txtmessage = document.getElementById('message');
            const data = {
                username: username,
                group_name: groupName,
                message: txtmessage.value
            };

            socket.emit('group_message', data);
            txtmessage.value = '';
        }

        socket.on('group_message', (data) => {
            const container = document.getElementById('container');
            const msg = `<p><b>${data.from}:</b> ${data.message} <i>${new Date(data.date_sent).toLocaleTimeString()}</i></p>`;
            container.innerHTML += msg;
        });

        function handleInput() {
            const message = document.getElementById('message');
            if (message.value.trim() !== "") {
                isTyping();
            } else {
                notTyping();
            }
        }

        function isTyping() {
            const groupRadio = document.querySelector('input[name="group"]:checked');
            const groupName = groupRadio ? groupRadio.value : null;
            if (!groupName) return;
            
            socket.emit('group_typing', { group_name: groupName, username: username });
        }

        function notTyping() {
            const groupRadio = document.querySelector('input[name="group"]:checked');
            const groupName = groupRadio ? groupRadio.value : null;
            if (!groupName) return;
            
            socket.emit('group_not_typing', { group_name: groupName, username: username });
        }

        socket.on('group_typing', (data) => {
            const isTypingDiv = document.getElementById('istyping');
            isTypingDiv.innerHTML = `<p>${data.from} is typing...</p>`;
        });

        socket.on('group_not_typing', (data) => {
            const isTypingDiv = document.getElementById('istyping');
            const regex = new RegExp(`<p>${data.from} is typing\\.\\.\\.</p>`, 'g');
            isTypingDiv.innerHTML = isTypingDiv.innerHTML.replace(regex, '');
        });

        function leaveGroup() {
            const groupRadio = document.querySelector('input[name="group"]:checked');
            const groupName = groupRadio ? groupRadio.value : null;
            if (!groupName) return;
            
            socket.emit('leave_group', groupName);
        }

        socket.on('clear_chat_history', () => {
            document.getElementById('container').innerHTML = ''; // Clear chat history
        });

    </script>

    <h4 id="socketID"></h4>
    <input type="radio" id="group1" name="group" value="devops">devops<br />
    <input type="radio" id="group2" name="group" value="cloud computing">cloud computing<br />
    <input type="radio" id="group3" name="group" value="covid19">covid19<br />
    <input type="radio" id="group4" name="group" value="sports">sports<br />
    <input type="radio" id="group5" name="group" value="nodeJS">nodeJS<br />
    <button onclick="joinGroup()">Join Group</button>
    <br />
    <input type="text" id="message" name="message" oninput="handleInput()" placeholder="Enter your message" />
    <button onclick="sendGroupMessage()">Send Message</button>
    <h3>Chat History</h3>
    <div id="container"></div>
    <div id="istyping"></div>
    <button onclick="leaveGroup()">Leave Group</button>
</body>
</html>
